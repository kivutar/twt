<!DOCTYPE html>
<html>

<head>

    <script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
    <script type="text/javascript">
        //var web3 = window.web3;
        web3 = new Web3(web3.currentProvider);
        web3.eth.defaultAccount = web3.eth.coinbase;
        //web3.setProvider(new web3.providers.HttpProvider('https://rinkeby.infura.io'));

        var ABI = [{ "constant": true, "inputs": [{ "name": "", "type": "uint256" }], "name": "hashes", "outputs": [{ "name": "sender", "type": "address" }, { "name": "content", "type": "string" }, { "name": "timestamp", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_hashContent", "type": "string" }], "name": "post", "outputs": [], "payable": true, "stateMutability": "payable", "type": "function" }, { "constant": true, "inputs": [], "name": "lastHashId", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "_hashSender", "type": "address" }, { "indexed": false, "name": "_hashId", "type": "uint256" }, { "indexed": false, "name": "_hashContent", "type": "string" }, { "indexed": false, "name": "timestamp", "type": "uint256" }], "name": "Message", "type": "event" }]
        var contractAddress = "0x199acc74a2e6262f583400d64085eb605825dfd5";
        var contract = web3.eth.contract(ABI).at(contractAddress);

        const node = new Ipfs({
            init: false,
            start: false,
            repo: 'ipfs-' + Math.random()
        });

        node.init(handleInit);

        function post(message) {
            ipfs.files.write('/dummy', Buffer.from(message), { create: true }, (err) => {
                ipfs.files.stat('/dummy', (err, stats) => {
                    console.log(stats.hash)
                    contract.post(stats.hash, { from: "0xd75f250914eac15ab3644b1c15bd27a77e326ba1" }, function (error, result) {
                        console.log(error, result);
                    });
                })
            })
        }

        function handleInit(err) {
            if (err) {
                throw err
            }
            node.start(() => {
                console.log('Online status: ', node.isOnline() ? 'online' : 'offline')
                document.getElementById("status").innerHTML = 'Node status: ' + (node.isOnline() ? 'online' : 'offline')

                //post("Bonjour");

                contract.Message({}, { fromBlock: 0, toBlock: 'latest' }).get((error, eventResults) => {
                    if (error)
                        console.log('Error in Message event handler: ' + error);

                    eventResults.forEach(function (result) {
                        ipfs.files.cat(result.args._hashContent, function (err, file) {
                            document.getElementById("messages").innerHTML += '<p>' + file.toString('utf8') + '</p>';
                        })
                    });
                });
            });
        }
    </script>
</head>

<body>
    <div id="status"></div>
    <div id="messages"></div>
</body>

</html>