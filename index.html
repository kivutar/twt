<!DOCTYPE html>
<html>

<head>
    <script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>
    <script type="text/javascript">
        var web3Instance = new Web3(Web3.givenProvider || Web3.currentProvider || 'https://rinkeby.infura.io');
        web3Instance.eth.defaultAccount = web3Instance.eth.coinbase;

        var ABI = [{ "constant": true, "inputs": [{ "name": "", "type": "uint256" }], "name": "hashes", "outputs": [{ "name": "sender", "type": "address" }, { "name": "content", "type": "string" }, { "name": "timestamp", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_hashContent", "type": "string" }], "name": "post", "outputs": [], "payable": true, "stateMutability": "payable", "type": "function" }, { "constant": true, "inputs": [], "name": "lastHashId", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "_hashSender", "type": "address" }, { "indexed": false, "name": "_hashId", "type": "uint256" }, { "indexed": false, "name": "_hashContent", "type": "string" }, { "indexed": false, "name": "timestamp", "type": "uint256" }], "name": "Message", "type": "event" }]
        var contractAddress = "0x199acc74a2e6262f583400d64085eb605825dfd5";
        var contract = new web3Instance.eth.Contract(ABI, contractAddress);

        const ipfsNode = window.ipfs; /*|| new Ipfs({
            repo: 'twt',
        });*/

        function post(message) {
            ipfsNode.files.add({ path: '/dummy', content: Buffer.from(message) }, (err, files) => {
                hash = files[0].hash;
                console.log('Posting ' + hash);
                //ipfsNode.pin.add(hash, function (err) { console.log(err); });
                contract.methods.post(hash).send({ from: web3.eth.defaultAccount }, function (err, result) {
                    console.log(err, result);
                });
            });
        }

        function insertMessage(id, sender, content) {
            document.getElementById("messages").innerHTML = '' +
                '<div id="twt-' + id + '">' +
                '<div class="sender"><a>Anonymous</a> <span>@' + sender.substring(2,10) + '</span></div>' +
                '<div class="content">' + content + '</div>' +
                '</div>' + document.getElementById("messages").innerHTML;
        }

        function updateMessage(id, sender, content) {
            document.getElementById("twt-" + id).innerHTML = '' +
                '<div class="sender"><a>Anonymous</a> <span>@' + sender.substring(2,10) + '</span></div>' +
                '<div class="content">' + content + '</div>';
        }

        function retrieveMessage(event) {
            console.log(event);
            var id = event.returnValues._hashId;
            var sender = event.returnValues._hashSender;
            var hash = event.returnValues._hashContent;

            console.log("Retrieving " + hash);
            if (ipfsNode) {
                ipfsNode.files.cat(hash, function (err, file) {
                    if (err) {
                        updateMessage(id, sender, err);
                    } else {
                        updateMessage(id, sender, file.toString('utf8'));
                    }
                });
            } else {
                fetch('https://ipfs.io/ipfs/' + hash)
                    .then(function (response) {
                        return response.text();
                    })
                    .then(function (text) {
                        updateMessage(id, sender, text);
                    })
            }
        }

        contract.getPastEvents('Message', { fromBlock: 0, toBlock: 'latest' }, (err, events) => {
            if (err)
                console.log('Error in Message event handler: ' + err);

            events.forEach(function (event) {
                insertMessage(event.returnValues._hashId, event.returnValues._hashSender, "<i>Loading...</i>");
                retrieveMessage(event);
            });
        });
    </script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div id="status"></div>
        <div id="twitter-app" class="clearfix">
            <input v-model="message">
            <button v-on:click="submitPost()">Post</button>
        </div>
        <div id="messages"></div>
    </div>
    <script>
        var app6 = new Vue({
            el: '#twitter-app',
            data: {
                message: ''
            },
            methods: {
                submitPost: function () {
                    post(this.$data.message)
                }
            }
        })
    </script>
</body>

</html>