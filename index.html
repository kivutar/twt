<!DOCTYPE html>
<html>

<head>
    <script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>
    <script type="text/javascript">
        var web3Instance = new Web3(Web3.givenProvider || Web3.currentProvider || 'https://rinkeby.infura.io');
        web3Instance.eth.defaultAccount = web3Instance.eth.coinbase;

        var ABI = [{ "constant": false, "inputs": [{ "name": "_hashContent", "type": "string" }, { "name": "_hashImage", "type": "string" }], "name": "post", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "", "type": "uint256" }], "name": "hashes", "outputs": [{ "name": "sender", "type": "address" }, { "name": "content", "type": "string" }, { "name": "image", "type": "string" }, { "name": "timestamp", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "lastHashId", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_hashAvatar", "type": "string" }], "name": "set_avatar", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "", "type": "address" }], "name": "avatars", "outputs": [{ "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "sender", "type": "address" }, { "indexed": false, "name": "id", "type": "uint256" }, { "indexed": false, "name": "cid", "type": "string" }, { "indexed": false, "name": "img", "type": "string" }, { "indexed": false, "name": "timestamp", "type": "uint256" }], "name": "Message", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "sender", "type": "address" }, { "indexed": false, "name": "cid", "type": "string" }], "name": "Avatar", "type": "event" }]
        var contractAddress = "0x5e626b58388f8b083d6d399f385c901675636b6e";
        var contract = new web3Instance.eth.Contract(ABI, contractAddress);
        var gateway = "https://ipfs.io/ipfs/";

        const ipfsNode = window.ipfs; /*|| new Ipfs({
            repo: 'twt',
        });*/

        async function post(message) {
            var err, files = await ipfsNode.files.add({ path: '/dummy', content: Buffer.from(message) });
            hash = files[0].hash;
            console.log('Posting ' + hash);
            ipfsNode.pin.add(hash, (err) => console.log(err));
            var err, result = await contract.methods.post(hash, '').send({ from: web3.eth.defaultAccount });
            console.log(err, result);
            // TODO empty the input field here
        }

        // function setAvatar(hash) {
        //     contract.methods.set_avatar(hash).send({ from: web3.eth.defaultAccount }, function (err, result) {
        //         console.log(err, result);
        //     });
        // }

        //setAvatar("zb2rhoTVGCTVkcUSnqsqHybw8bP7ENvEpRL9e5yBgogWTPm1o");

        function formatMessage(id, sender, content, img, timestamp) {
            return '' +
                '<img class="avatar" src="avatar.jpg">' +
                '<div class="sender">' +
                '<a href="?u=' + sender + '">Anonymous</a> ' +
                '<span>@' + sender.substring(2, 10) + '</span>' +
                ' Â· <span>' + new Date(timestamp * 1000).toLocaleString() + '</span>' +
                '</div>' +
                '<div class="content">' + content + '</div>' +
                (img ? '<img class="image" src="image.png">' : '') +
                '<div class="actions">' +
                '<a href=""><i class="fas fa-comment-alt"></i></a>' +
                '<a href=""><i class="fas fa-retweet"></i></a>' +
                '<a href=""><i class="fas fa-heart"></i></a>' +
                '<a href=""><i class="fas fa-thumbtack"></i></a>' +
                '<a href=""><i class="fas fa-envelope"></i></a>' +
                '</div>';
        }

        function insertMessage(id, sender, content, img, timestamp) {
            document.getElementById("messages").innerHTML = '' +
                '<div id="twt-' + id + '">' +
                formatMessage(id, sender, content, img, timestamp) +
                '</div>' + document.getElementById("messages").innerHTML;
        }

        function updateMessage(id, content) {
            document.querySelector("#twt-" + id + " .content").innerHTML = content;
        }

        async function retrieveMessage(id, cid) {
            console.log("Retrieving message " + cid);
            if (ipfsNode) {
                var err, file = await ipfsNode.files.cat(cid);
                if (err) {
                    console.log(err);
                    updateMessageFallback(id, cid);
                } else {
                    updateMessage(id, file.toString('utf8'));
                }
            } else {
                updateMessageFallback(id, cid);
            }
        }

        async function retrieveImage(id, cid, selector) {
            console.log("Retrieving image " + cid);
            if (ipfsNode) {
                var err, file = await ipfsNode.files.cat(cid);
                if (err) {
                    document.querySelector(selector).src = gateway + cid;
                } else {
                    var blob = new Blob([file]);
                    var url = window.URL.createObjectURL(blob);
                    document.querySelector(selector).src = url;
                }
            } else {
                document.querySelector(selector).src = gateway + cid;
            }
        }

        async function findAvatar(id, sender) {
            var err, cid = await contract.methods.avatars(sender).call();
            cid && retrieveImage(id, cid, "#twt-" + id + " .avatar");
        }

        function updateMessageFallback(id, cid) {
            fetch(gateway + cid)
                .then(function (response) {
                    return response.text();
                })
                .then(function (text) {
                    updateMessage(id, text);
                })
        }

        function buildTweetList(filter) {
            contract.getPastEvents('Message', { fromBlock: 0, filter: filter }, (err, messages) => {
                messages.forEach(function (event) {
                    var id = event.returnValues.id;
                    var sender = event.returnValues.sender;
                    var img = event.returnValues.img;
                    insertMessage(id, sender, "<i>Loading...</i>", img, event.returnValues.timestamp);
                    retrieveMessage(id, event.returnValues.cid);
                    findAvatar(id, sender);
                    if (img) {
                        retrieveImage(id, img, "#twt-" + id + " .image");
                    }
                });
            });
        }

        var u = new URLSearchParams(window.location.search).get('u');
        if (u) {
            buildTweetList({ sender: u });
        } else {
            buildTweetList();
        }
    </script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt"
        crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div id="status"></div>
        <div id="twitter-app" class="clearfix">
            <textarea v-model="message"></textarea>
            <button v-on:click="submitPost()">Post</button>
        </div>
        <div id="messages"></div>
    </div>
    <script>
        var app6 = new Vue({
            el: '#twitter-app',
            data: {
                message: ''
            },
            methods: {
                submitPost: function () {
                    post(this.$data.message)
                }
            }
        })
    </script>
</body>

</html>